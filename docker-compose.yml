version: '3.8'

services:
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:stable
    container_name: ib-gateway
    restart: unless-stopped
    environment:
      - TRADING_MODE=${IBKR_TRADING_MODE:-paper}
      - TWS_USERID=${IBKR_USERID}
      - TWS_PASSWORD=${IBKR_PASSWORD}
      - TWS_USERID_PAPER=${IBKR_USERID_PAPER}
      - TWS_PASSWORD_PAPER=${IBKR_PASSWORD_PAPER}
      - TWS_ACCEPT_INCOMING=accept
      - VNC_SERVER_PASSWORD=${VNC_PASSWORD:-}
      - READ_ONLY_API=${READONLY:-false}
      - TWOFA_TIMEOUT_ACTION=restart
    ports:
      - "${IBKR_GATEWAY_PAPER_PORT:-4004}:4004"
      - "${IBKR_GATEWAY_LIVE_PORT:-4003}:4003"
      - "5900:5900"  # VNC port for monitoring
    volumes:
      - ib-gateway-data:/home/ibgateway
    networks:
      - ibkr-network

  mcp-server:
    image: ghcr.io/metaif/ibkr-mcp-docker:latest
    container_name: ibkr-mcp-server
    restart: unless-stopped
    depends_on:
      - ib-gateway
    environment:
      - IBKR_HOST=ib-gateway
      - IBKR_GATEWAY_LIVE_PORT=${IBKR_GATEWAY_LIVE_PORT:-4003}
      - IBKR_GATEWAY_PAPER_PORT=${IBKR_GATEWAY_PAPER_PORT:-4004}
      - IBKR_TRADING_MODE=${IBKR_TRADING_MODE:-paper}
      - IBKR_CLIENT_ID=1
      - SERVER_PORT=${SERVER_PORT:-8080}
      - READONLY=${READONLY:-false}
    ports:
      - "${SERVER_PORT:-8080}:${SERVER_PORT:-8080}"  # HTTP/SSE port
    networks:
      - ibkr-network

volumes:
  ib-gateway-data:

networks:
  ibkr-network:
    driver: bridge
